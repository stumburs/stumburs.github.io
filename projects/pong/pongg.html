<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.3.1/p5.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
            crossorigin="anonymous"
        />
        <script src="/js/favicon.js"></script>
        <link rel="stylesheet" href="/css/style.css" />
        <title>Pong</title>
    </head>
    <body>
        <!-- Nav -->
        <script src="/js/navbar.js"></script>

        <div class="title-text">
            <h1 class="title display-1">Pong</h1>
        </div>

        <div class="content">
            <canvas id="canvas">
                HTML5 canvas appears to be unsupported in the current
                browser.<br />
                Please try updating or use a different browser.
            </canvas>
            <div id="status">
                <div
                    id="status-progress"
                    style="display: none"
                    oncontextmenu="event.preventDefault();"
                >
                    <div id="status-progress-inner"></div>
                </div>
                <div
                    id="status-indeterminate"
                    style="display: none"
                    oncontextmenu="event.preventDefault();"
                >
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div
                    id="status-notice"
                    class="godot"
                    style="display: none"
                ></div>
            </div>

            <script type="text/javascript" src="Pong.js"></script>
            <script type="text/javascript">
                //<![CDATA[

                const GODOT_CONFIG = {
                    args: [],
                    canvasResizePolicy: 2,
                    executable: "Pong",
                    experimentalVK: false,
                    fileSizes: { "Pong.pck": 285264, "Pong.wasm": 13788612 },
                    focusCanvas: true,
                    gdnativeLibs: [],
                };
                var engine = new Engine(GODOT_CONFIG);

                (function () {
                    const INDETERMINATE_STATUS_STEP_MS = 100;
                    var statusProgress =
                        document.getElementById("status-progress");
                    var statusProgressInner = document.getElementById(
                        "status-progress-inner"
                    );
                    var statusIndeterminate = document.getElementById(
                        "status-indeterminate"
                    );
                    var statusNotice = document.getElementById("status-notice");

                    var initializing = true;
                    var statusMode = "hidden";

                    var animationCallbacks = [];
                    function animate(time) {
                        animationCallbacks.forEach((callback) =>
                            callback(time)
                        );
                        requestAnimationFrame(animate);
                    }
                    requestAnimationFrame(animate);

                    function setStatusMode(mode) {
                        if (statusMode === mode || !initializing) return;
                        [
                            statusProgress,
                            statusIndeterminate,
                            statusNotice,
                        ].forEach((elem) => {
                            elem.style.display = "none";
                        });
                        animationCallbacks = animationCallbacks.filter(
                            function (value) {
                                return value != animateStatusIndeterminate;
                            }
                        );
                        switch (mode) {
                            case "progress":
                                statusProgress.style.display = "block";
                                break;
                            case "indeterminate":
                                statusIndeterminate.style.display = "block";
                                animationCallbacks.push(
                                    animateStatusIndeterminate
                                );
                                break;
                            case "notice":
                                statusNotice.style.display = "block";
                                break;
                            case "hidden":
                                break;
                            default:
                                throw new Error("Invalid status mode");
                        }
                        statusMode = mode;
                    }

                    function animateStatusIndeterminate(ms) {
                        var i = Math.floor(
                            (ms / INDETERMINATE_STATUS_STEP_MS) % 8
                        );
                        if (
                            statusIndeterminate.children[i].style
                                .borderTopColor == ""
                        ) {
                            Array.prototype.slice
                                .call(statusIndeterminate.children)
                                .forEach((child) => {
                                    child.style.borderTopColor = "";
                                });
                            statusIndeterminate.children[
                                i
                            ].style.borderTopColor = "#dfdfdf";
                        }
                    }

                    function setStatusNotice(text) {
                        while (statusNotice.lastChild) {
                            statusNotice.removeChild(statusNotice.lastChild);
                        }
                        var lines = text.split("\n");
                        lines.forEach((line) => {
                            statusNotice.appendChild(
                                document.createTextNode(line)
                            );
                            statusNotice.appendChild(
                                document.createElement("br")
                            );
                        });
                    }

                    function displayFailureNotice(err) {
                        var msg = err.message || err;
                        console.error(msg);
                        setStatusNotice(msg);
                        setStatusMode("notice");
                        initializing = false;
                    }

                    if (!Engine.isWebGLAvailable()) {
                        displayFailureNotice("WebGL not available");
                    } else {
                        setStatusMode("indeterminate");
                        engine
                            .startGame({
                                onProgress: function (current, total) {
                                    if (total > 0) {
                                        statusProgressInner.style.width =
                                            (current / total) * 100 + "%";
                                        setStatusMode("progress");
                                        if (current === total) {
                                            // wait for progress bar animation
                                            setTimeout(() => {
                                                setStatusMode("indeterminate");
                                            }, 500);
                                        }
                                    } else {
                                        setStatusMode("indeterminate");
                                    }
                                },
                            })
                            .then(() => {
                                setStatusMode("hidden");
                                initializing = false;
                            }, displayFailureNotice);
                    }
                })();
                //]]>
            </script>
            <!-- <script src="/projects/pong/Pong.js"></script> -->
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"
        ></script>
    </body>
</html>
